# Інструкція з створення модифікованої версії Rancher

## 1. Підготовка середовища

1.1. Встановіть необхідні інструменти:
   - Go (версія 1.16 або новіша)
   - Docker
   - Git

1.2. Клонуйте репозиторій Rancher:
```bash
git clone https://github.com/rancher/rancher.git
cd rancher
```

## 2. Модифікація коду

2.1. Створіть нову гілку для модифікацій:
```bash
git checkout -b custom-rancher-mod
```

2.2. Вимкнення самовідновлення Rancher:
Відкрийте файл `pkg/controllers/management/controller.go` і знайдіть функцію `Register`. Закоментуйте або видаліть рядки, що відповідають за самовідновлення.

2.3. Вимкнення реакції на видалення кластера:
Знайдіть файл, що відповідає за обробку видалення кластера (наприклад, `pkg/controllers/management/cluster/cluster.go`) і модифікуйте відповідну функцію:

```go
func (c *Controller) Remove(cluster *v3.Cluster) (runtime.Object, error) {
    // Закоментуйте або видаліть код, що виконує видалення
    // return nil, nil
    logrus.Infof("Cluster deletion is temporarily disabled: %s", cluster.Name)
    return cluster, nil
}
```

2.4. Додайте конфігураційний прапорець для ввімкнення/вимкнення модифікацій:
У файлі `pkg/app/app.go` додайте новий прапорець:

```go
DisableClusterDeletion = cli.BoolFlag{
    Name:   "disable-cluster-deletion",
    Usage:  "Disable cluster deletion handling",
    EnvVar: "RANCHER_DISABLE_CLUSTER_DELETION",
}
```

Використайте цей прапорець у відповідних частинах коду.

## 3. Збірка модифікованої версії

3.1. Зберіть бінарний файл:
```bash
go build -o rancher
```

3.2. Створіть Docker-образ:
Створіть або модифікуйте `Dockerfile`:

```dockerfile
FROM ubuntu:20.04
RUN apt-get update && apt-get install -y ca-certificates
COPY rancher /usr/bin/
CMD ["rancher"]
```

Зберіть образ:
```bash
docker build -t custom-rancher:v1 .
```

## 4. Тестування

4.1. Запустіть модифіковану версію Rancher локально:
```bash
docker run -d --name custom-rancher -p 80:80 -p 443:443 custom-rancher:v1
```

4.2. Перевірте функціональність:
   - Спробуйте видалити кластер і переконайтеся, що це дія блокується.
   - Перевірте, що самовідновлення вимкнено.

## 5. Документація використання

5.1. Для тимчасових обхідних шляхів:
   - Розгорніть модифіковану версію Rancher.
   - Застосуйте необхідні конфігурації або виправлення.
   - Після вирішення проблеми поверніться до стандартної версії.

5.2. Для міграції кластерів RKE:
   - Розгорніть модифіковану версію Rancher з вимкненою реакцією на видалення кластера.
   - Виконайте процес міграції кластера.
   - Повторно приєднайте кластери до модифікованої версії Rancher.
   - Після завершення міграції, поверніться до стандартної версії Rancher.

5.3. Для перевірки помилок у висхідному потоці:
   - Використовуйте модифіковану версію для ізоляції проблеми.
   - Збирайте розширені логи та діагностичну інформацію.

5.4. Для міграції з RKE1 на RKE2:
   - Розгорніть модифіковану версію Rancher.
   - Виконайте процес міграції з RKE1 на RKE2, використовуючи стандартні інструменти Rancher.
   - Модифікована версія дозволить уникнути проблем з автоматичним видаленням старих кластерів.

## 6. Відновлення стандартної версії

6.1. Збережіть всі необхідні дані та конфігурації.
6.2. Зупиніть модифіковану версію Rancher.
6.3. Розгорніть стандартну версію Rancher.
6.4. Відновіть дані та конфігурації, якщо необхідно.

## 7. Безпека

- Регулярно оновлюйте базовий код Rancher до останньої версії.
- Застосовуйте всі необхідні патчі безпеки.
- Обмежте доступ до модифікованої версії Rancher лише для авторизованого персоналу.
